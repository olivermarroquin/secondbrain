#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'EOF' >&2
usage:
  jobs-apply-batch <limit> [batch_number|--batch auto] [--date YYYY-MM-DD] [--dry-run]

behavior:
  - resolves date D (default: today)
  - resolves batch number (explicit N or --batch auto)
  - builds queue file: /tmp/applied-D-batchN.txt
  - opens not_applied URLs and writes APP paths to queue file
  - if --date is provided, only opens jobs with date_found == that date

examples:
  jobs-apply-batch 25 --batch auto
  jobs-apply-batch 25 --batch auto --date "$(date +%F)"
  jobs-apply-batch 10 2 --dry-run
EOF
  exit 2
}

[[ $# -ge 1 ]] || usage
LIMIT="${1:-}"
shift || true

[[ "$LIMIT" =~ ^[0-9]+$ ]] || { echo "ERROR: limit must be numeric" >&2; exit 1; }

DATE="$(date +%F)"
DRYRUN=0
BATCH_MODE=""
BATCH_NUM=""
REQUIRE_DATE=""

# parse remaining args
while [[ $# -gt 0 ]]; do
  case "$1" in
    --batch)
      BATCH_MODE="${2:-}"; shift 2 ;;
    --date)
      REQUIRE_DATE="${2:-}"; shift 2 ;;
    --dry-run)
      DRYRUN=1; shift ;;
    -h|--help)
      usage ;;
    *)
      # positional batch_number
      if [[ -z "$BATCH_NUM" && "$1" =~ ^[0-9]+$ ]]; then
        BATCH_NUM="$1"; shift
      else
        echo "Unknown arg: $1" >&2
        usage
      fi
      ;;
  esac
done

# batch number resolution
if [[ "$BATCH_MODE" == "auto" ]]; then
  # find next available N for DATE (max existing + 1)
  N=1
  while [[ -f "/tmp/applied-${DATE}-batch${N}.txt" ]]; do
    ((N++))
  done
  BATCH_NUM="$N"
else
  [[ -z "$BATCH_NUM" ]] && BATCH_NUM="1"
fi

Q="/tmp/applied-${DATE}-batch${BATCH_NUM}.txt"

echo "Date:  $DATE"
echo "Queue: $Q"
echo

ARGS=(--limit "$LIMIT" --queue "$Q")
(( DRYRUN == 1 )) && ARGS+=(--dry-run)
[[ -n "$REQUIRE_DATE" ]] && ARGS+=(--require-date "$REQUIRE_DATE")

jobs-open-unapplied "${ARGS[@]}"

echo
echo "Next (after you apply):"
echo "jobs-batch-mark-applied --date \"${DATE}\" --paths-file \"${Q}\" --apply --commit --message \"status: batch -> applied (${DATE}) batch ${BATCH_NUM}\""
echo "git push"
