#!/Users/olivermarroquin/secondbrain/07_system/venvs/docgen/bin/python
import argparse, json
from pathlib import Path
from datetime import datetime, timezone

def die(msg: str, code=1):
    print(f"ERROR: {msg}")
    raise SystemExit(code)

def load_json(p: Path):
    try:
        return json.loads(p.read_text())
    except Exception as e:
        die(f"invalid JSON: {p} ({e})")

def main():
    ap = argparse.ArgumentParser()
    ap.add_argument("--app", required=True)
    ap.add_argument("--no-write", action="store_true")
    args = ap.parse_args()

    app = Path(args.app).expanduser()
    if not app.is_dir():
        die(f"app dir missing: {app}")

    jd_p = app / "jd" / "jd-raw.txt"
    jm_p = app / "tracking" / "job-meta.json"
    if not jd_p.exists(): die(f"missing: {jd_p}")
    if jd_p.stat().st_size == 0: die(f"jd-raw.txt empty: {jd_p}")
    if not jm_p.exists(): die(f"missing: {jm_p}")

    jd_raw = jd_p.read_text(errors="ignore")

    # optional hint
    ks_p = app / "notes" / "keyword-scout.json"
    keyword_scout = None
    if ks_p.exists():
        try:
            keyword_scout = load_json(ks_p).get("keyword_scout")
        except Exception:
            keyword_scout = None

    scripts_dir = Path.home() / "secondbrain/01_projects/resume-factory/scripts"
    if not scripts_dir.is_dir():
        die(f"missing scripts dir: {scripts_dir}")
    import sys
    sys.path.insert(0, str(scripts_dir))

    from rf_ideal_profile_client import ideal_profile_openai
    from rf_ideal_profile_schema import validate_ideal_profile

    data = ideal_profile_openai(
        jd_raw=jd_raw,
        keyword_scout=keyword_scout,
        model=None,
        timeout_s=int(__import__("os").environ.get("RF_OPENAI_TIMEOUT_S", "90")),
    )

    ok, msg = validate_ideal_profile(data)
    if not ok:
        dbg_p = app / "notes" / "ideal-profile.invalid.json"
        dbg_p.parent.mkdir(parents=True, exist_ok=True)
        dbg_p.write_text(json.dumps(data, indent=2) + "\n", encoding="utf-8")
        die(f"ideal-profile schema invalid: {msg} (wrote {dbg_p})")

    profile = data.get("ideal_profile") if isinstance(data, dict) else None
    notes = data.get("notes", "") if isinstance(data, dict) else ""

    out = {
        "generated_at_utc": datetime.now(timezone.utc).isoformat(),
        "app": str(app),
        "job_meta": load_json(jm_p),
        "ideal_profile": profile if profile is not None else data,
        "notes": notes,
    }

    out_p = app / "notes" / "ideal-profile.json"
    if args.no_write:
        print(json.dumps(out, indent=2))
        return

    out_p.parent.mkdir(parents=True, exist_ok=True)
    out_p.write_text(json.dumps(out, indent=2) + "\n", encoding="utf-8")
    print(f"WROTE: {out_p}")

if __name__ == "__main__":
    main()
