#!/usr/bin/env bash
set -euo pipefail

if [[ $# -ne 1 ]]; then
  echo "Usage: project-switch <project_path>"
  exit 1
fi

TARGET_PATH="$1"

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
cd "$REPO_ROOT"

if [[ ! -d "$TARGET_PATH" ]]; then
  echo "Error: project path does not exist: $TARGET_PATH"
  echo "Create it first, e.g.: mkdir -p \"$TARGET_PATH\""
  exit 1
fi

GLOBAL_STATUS="07_system/state/STATUS.md"
GLOBAL_NEXT="07_system/state/NEXT.md"

if [[ ! -f "$GLOBAL_STATUS" ]]; then
  echo "Error: missing $GLOBAL_STATUS"
  exit 1
fi

if [[ ! -f "$GLOBAL_NEXT" ]]; then
  echo "Error: missing $GLOBAL_NEXT"
  exit 1
fi

# --- Safety: refuse switch if there are uncommitted NON-state changes ---
CHANGED_FILES="$(git status --porcelain | awk '{print $2}')"
if [[ -n "${CHANGED_FILES:-}" ]]; then
  DISALLOWED="$(printf "%s\n" "$CHANGED_FILES" \
    | grep -Ev '^(07_system/state/|01_projects/[^/]+/state/)' || true)"
  if [[ -n "${DISALLOWED:-}" ]]; then
    echo "Refusing to switch: you have uncommitted NON-state changes:"
    echo
    printf "  %s\n" $DISALLOWED
    echo
    echo "Do one of these, then re-run:"
    echo "  - Commit (preferred): git add -p && git commit -m \"...\" && git push"
    echo "  - Stash (only if necessary): git stash push -m \"wip: before switch\""
    exit 1
  fi
fi

echo "== Project switch =="
echo "Target project path: $TARGET_PATH"
echo

# Close current session (logs + forces review)
echo "== Closing current session =="
"$REPO_ROOT/07_system/bin/session-close"

echo
echo "== Updating global STATUS =="
PROJECT_NAME="$(basename "$TARGET_PATH")"

# Active project path
if grep -qE '^Active project path:' "$GLOBAL_STATUS"; then
  sed -i '' "s|^Active project path:.*|Active project path: $TARGET_PATH|" "$GLOBAL_STATUS"
else
  awk -v p="$TARGET_PATH" 'NR==1{print; print ""; print "Active project path: " p; next} {print}' \
    "$GLOBAL_STATUS" > "$GLOBAL_STATUS.tmp" && mv "$GLOBAL_STATUS.tmp" "$GLOBAL_STATUS"
fi

# Name + Location (best-effort; requires those lines exist)
sed -i '' "s|^- Name:.*|- Name: $PROJECT_NAME|" "$GLOBAL_STATUS" || true
sed -i '' "s|^- Location:.*|- Location: $TARGET_PATH|" "$GLOBAL_STATUS" || true

# Ensure project state exists
echo
echo "== Ensuring project state exists =="
"$REPO_ROOT/07_system/bin/project-init-state" "$TARGET_PATH"

# Derive focus from project NEXT.md (contract: a line starting with 'Focus: ')
PROJECT_NEXT="$TARGET_PATH/state/NEXT.md"
FOCUS_LINE="$(grep -E '^Focus: ' "$PROJECT_NEXT" 2>/dev/null | head -n 1 || true)"
if [[ -z "${FOCUS_LINE:-}" ]]; then
  echo "Error: missing required Focus line in $PROJECT_NEXT"
  echo "Add exactly one line like:"
  echo "  Focus: <one sentence, <= 120 chars>"
  exit 1
fi
FOCUS_VALUE="${FOCUS_LINE#Focus: }"

echo
echo "== Updating global focus + global NEXT pointer =="

# Replace the first bullet under "## Current focus"
perl -0777 -i -pe 's/(## Current focus\s*\n- ).*/$1'"$(printf '%s' "$FOCUS_VALUE" | sed 's/[\/&]/\\&/g')"'/m' "$GLOBAL_STATUS"

# Rewrite global NEXT as routing-only (no accumulation)
cat > "$GLOBAL_NEXT" <<EOF2
# NEXT (Global)

## Task #0 (always allowed)
- If this file is not accurate, update it first.

## Routing pointer
- Active project NEXT: $TARGET_PATH/state/NEXT.md
EOF2

echo "Active project path now:"
grep -E '^Active project path:' "$GLOBAL_STATUS" || true
echo

echo "== Starting new session =="
"$REPO_ROOT/07_system/bin/session-start"

echo
echo "Switch complete."
echo "Reminder: commit/push state changes now if needed:"
echo "  git status -sb"
