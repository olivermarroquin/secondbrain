#!/usr/bin/env bash
set -euo pipefail

# Usage:
#   sz-ask "your question"
#   sz-ask gemini "your question"
#   sz-ask codex "your question"

ENGINE="gemini"
if [[ "$1" == "gemini" || "$1" == "codex" ]]; then
  ENGINE="$1"
  shift
fi

QUESTION="$*"
[[ -n "$QUESTION" ]] || { echo "usage: sz-ask [gemini|codex] \"question\""; exit 2; }

ROOT="$(git rev-parse --show-toplevel 2>/dev/null || true)"
[[ -n "$ROOT" ]] || { echo "error: not in a git repo"; exit 2; }

STUDY="$ROOT/01_projects/study_zone"
ACTIVE="$STUDY/notes/ACTIVE.md"

get() { sed -n "s/^$1: //p" "$ACTIVE"; }

PROBLEM="$(get problem_file)"
SOLUTION="$(get solution_file)"
REVIEW="$(get review_file)"

PROMPT=$(cat <<EOF2
Context (do not restate unless needed):
- Problem: $PROBLEM
- Solution: $SOLUTION
- Review: $REVIEW

Question:
$QUESTION

Rules:
- Be concise.
- Focus on reasoning, edge cases, and interview angles.
- Do NOT rewrite files unless explicitly asked.
EOF2
)

DEBUG=0
if [[ "${1:-}" == "--debug" ]]; then
  DEBUG=1
  shift
fi

if [[ "$DEBUG" -eq 1 ]]; then
echo
echo "=== $ENGINE QUESTION CONTEXT ==="
echo "$PROMPT"
echo "==============================="
echo
fi

case "$ENGINE" in
  gemini)
    printf "%s\n" "$PROMPT" | gemini -p ""
    ;;
  codex)
    exec codex
    ;;
esac

