#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'EOF' >&2
usage:
  job-intake-from-stdin --app /abs/or/~/path/to/app [--apply] [--force]

behavior:
  - reads JD text from STDIN and writes to <app>/jd/jd-raw.txt
  - default is DRY RUN (captures to temp, prints line count + preview)
  - --apply required to write
  - refuses to overwrite existing non-empty jd-raw.txt unless --force
  - --apply requires typing APPLY

examples:
  # paste interactively (finish with Ctrl+D)
  job-intake-from-stdin --app "$APP"

  # write for real (finish with Ctrl+D, then confirm APPLY)
  job-intake-from-stdin --app "$APP" --apply

  # overwrite existing jd-raw.txt
  job-intake-from-stdin --app "$APP" --apply --force

  # pipe from a file
  cat ~/Downloads/jd.txt | job-intake-from-stdin --app "$APP" --apply
EOF
  exit 2
}

APP=""
APPLY=0
FORCE=0

for arg in "$@"; do
  case "$arg" in
    -h|--help) usage ;;
  esac
done

while [[ $# -gt 0 ]]; do
  case "$1" in
    --app) APP="${2:-}"; shift 2 ;;
    --apply) APPLY=1; shift 1 ;;
    --force) FORCE=1; shift 1 ;;
    -h|--help) usage ;;
    *) echo "Unknown arg: $1" >&2; usage ;;
  esac
done

[[ -n "$APP" ]] || usage

# expand ~
if [[ "$APP" == ~* ]]; then
  APP="${APP/#\~/$HOME}"
fi

[[ -d "$APP" ]] || { echo "ERROR: app dir missing: $APP" >&2; exit 1; }
[[ -d "$APP/jd" ]] || { echo "ERROR: missing jd/ folder: $APP/jd" >&2; exit 1; }

OUT="$APP/jd/jd-raw.txt"

# overwrite guard
if [[ -f "$OUT" ]] && [[ -s "$OUT" ]] && (( FORCE == 0 )); then
  echo "ERROR: jd-raw.txt already exists and is non-empty."
  echo "Use --force to overwrite."
  exit 1
fi

TMP="$(mktemp)"
trap 'rm -f "$TMP" 2>/dev/null || true' EXIT

echo "Paste JD now. Finish with Ctrl+D."
cat > "$TMP"

if [[ ! -s "$TMP" ]]; then
  echo "ERROR: captured JD is empty." >&2
  exit 1
fi

LINES="$(wc -l < "$TMP" | tr -d ' ')"

echo
echo "APP : $APP"
echo "OUT : $OUT"
echo "TXT : ${LINES} lines"
echo
echo "Preview (first 8):"
sed -n '1,8p' "$TMP"
echo
echo "Preview (last 3):"
tail -n 3 "$TMP"
echo

if (( APPLY == 0 )); then
  echo "DRY RUN â€” nothing written. Re-run with --apply to write into jd-raw.txt."
  exit 0
fi

read -r -p "Type APPLY to write into jd-raw.txt: " CONFIRM
if [[ "$CONFIRM" != "APPLY" ]]; then
  echo "Aborted."
  exit 1
fi

mv "$TMP" "$OUT"
trap - EXIT

echo
echo "Wrote:"
wc -l "$OUT"
echo
echo "Verify (first 5):"
sed -n '1,5p' "$OUT"
echo
echo "Verify (last 1):"
sed -n '$p' "$OUT"
echo "OK"
