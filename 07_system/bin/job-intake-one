#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'EOF' >&2
usage:
  job-intake-one
    --company snake_case
    --date YYYY-MM-DD
    --role kebab-case
    --url "https://..."
    [--role-title "Human Title"]
    [--seniority junior|mid|senior|lead|unknown]
    [--location "Remote"|...]
    [--employment-type W2|C2C|...]
    [--priority low|medium|high|unknown]
    [--family qa_automation_engineer]
    [--force]
    [--source clipboard|url|stdin]
    [--dry-run]
    [--commit] [--push]

behavior:
  - INIT via job-intake-init
  - JD capture via --source (default clipboard):
      • clipboard: job-intake-from-clipboard
      • url:       job-intake-from-url
      • stdin:     job-intake-jd (Ctrl+D)
  - --dry-run runs capture tool in preview mode (no write)
  - overwrite protection: refuses overwrite unless --force
  - --push requires --commit
EOF
  exit 2
}

for arg in "$@"; do
  case "$arg" in
    -h|--help) usage ;;
  esac
done

COMPANY=""
DATE=""
ROLE=""
URL=""

ROLE_TITLE=""
SENIORITY=""
LOCATION=""
EMPLOYMENT_TYPE=""
PRIORITY=""
FAMILY=""
FORCE=0

SOURCE="clipboard"   # clipboard|url|stdin

DRYRUN=0
COMMIT=0
PUSH=0

while [[ $# -gt 0 ]]; do
  case "$1" in
    --company) COMPANY="${2:-}"; shift 2 ;;
    --date) DATE="${2:-}"; shift 2 ;;
    --role) ROLE="${2:-}"; shift 2 ;;
    --url) URL="${2:-}"; shift 2 ;;

    --role-title) ROLE_TITLE="${2:-}"; shift 2 ;;
    --seniority) SENIORITY="${2:-}"; shift 2 ;;
    --location) LOCATION="${2:-}"; shift 2 ;;
    --employment-type) EMPLOYMENT_TYPE="${2:-}"; shift 2 ;;
    --priority) PRIORITY="${2:-}"; shift 2 ;;
    --family) FAMILY="${2:-}"; shift 2 ;;
    --force) FORCE=1; shift 1 ;;

    --source) SOURCE="${2:-}"; shift 2 ;;
    --dry-run) DRYRUN=1; shift 1 ;;
    --commit) COMMIT=1; shift 1 ;;
    --push) PUSH=1; shift 1 ;;
    -h|--help) usage ;;
    *) echo "Unknown arg: $1" >&2; usage ;;
  esac
done

[[ -n "$COMPANY" && -n "$DATE" && -n "$ROLE" && -n "$URL" ]] || usage
(( PUSH == 0 || COMMIT == 1 )) || { echo "ERROR: --push requires --commit" >&2; exit 1; }

case "$SOURCE" in
  clipboard|url|stdin) ;;
  *) echo "ERROR: --source must be clipboard|url|stdin" >&2; exit 1 ;;
esac

INIT_ARGS=(--company "$COMPANY" --date "$DATE" --role "$ROLE" --url "$URL")
[[ -n "$ROLE_TITLE" ]] && INIT_ARGS+=(--role-title "$ROLE_TITLE")
[[ -n "$SENIORITY" ]] && INIT_ARGS+=(--seniority "$SENIORITY")
[[ -n "$LOCATION" ]] && INIT_ARGS+=(--location "$LOCATION")
[[ -n "$EMPLOYMENT_TYPE" ]] && INIT_ARGS+=(--employment-type "$EMPLOYMENT_TYPE")
[[ -n "$PRIORITY" ]] && INIT_ARGS+=(--priority "$PRIORITY")
[[ -n "$FAMILY" ]] && INIT_ARGS+=(--family "$FAMILY")
(( FORCE == 1 )) && INIT_ARGS+=(--force)

APP="$(job-intake-init "${INIT_ARGS[@]}" | head -n 1)"
[[ -n "$APP" ]] || { echo "ERROR: job-intake-init did not return an app path" >&2; exit 1; }

echo "APP: $APP"
echo "SRC: $SOURCE"
echo

FORCE_OPT=""
(( FORCE == 1 )) && FORCE_OPT="--force"

if (( DRYRUN == 1 )); then
  case "$SOURCE" in
    clipboard) job-intake-from-clipboard --app "$APP" ;;
    url)       job-intake-from-url --app "$APP" --url "$URL" ;;
    stdin)     job-intake-jd --app "$APP" ;;
  esac
  echo
  echo "DRY RUN complete. Nothing committed."
  echo "$APP"
  exit 0
fi

case "$SOURCE" in
  clipboard)
    echo "JD capture (clipboard): copy full JD in browser (Cmd+C), then press Enter."
    read -r -p "Press Enter to read clipboard: " _
    if [[ -n "$FORCE_OPT" ]]; then
      job-intake-from-clipboard --app "$APP" --apply --force
    else
      job-intake-from-clipboard --app "$APP" --apply
    fi
    ;;
  url)
    if [[ -n "$FORCE_OPT" ]]; then
      job-intake-from-url --app "$APP" --url "$URL" --apply --force
    else
      job-intake-from-url --app "$APP" --url "$URL" --apply
    fi
    ;;
  stdin)
    job-intake-jd --app "$APP"
    ;;
esac

if (( COMMIT == 1 )); then
  if (( PUSH == 1 )); then
    job-intake-commit --app "$APP"
  else
    job-intake-commit --app "$APP" --no-push
  fi
else
  echo
  echo "Next:"
  echo "  job-intake-commit --app \"$APP\""
fi

echo
echo "$APP"
