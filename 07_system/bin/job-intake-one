#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'EOF' >&2
usage:
  job-intake-one
    --company snake_case
    --date YYYY-MM-DD
    --role kebab-case
    --url "https://..."
    [--role-title "Human Title"]
    [--seniority junior|mid|senior|lead|unknown]
    [--location "Remote"|...]
    [--employment-type W2|C2C|...]
    [--priority low|medium|high|unknown]
    [--family qa_automation_engineer]
    [--force]
    [--dry-run]
    [--commit] [--push] [--message "..."]

behavior:
  - INIT: creates folders + tracking via job-intake-init
  - JD: captures jd-raw.txt from clipboard via job-intake-from-clipboard
  - COMMIT: commits via job-intake-commit (optional)
  - default is LIVE write for JD (asks you to type APPLY); use --dry-run to preview only
  - --push requires --commit

examples:
  job-intake-one --company robert_half --date 2026-01-23 --role sr-qa-automation-engineer --url "https://..." --commit --push
  job-intake-one --company icf --date "$(date +%F)" --role senior-qa-automation-engineer --url "https://..." --dry-run
EOF
  exit 2
}

# early help
for arg in "$@"; do
  case "$arg" in
    -h|--help) usage ;;
  esac
done

# required
COMPANY=""
DATE=""
ROLE=""
URL=""

# optional meta
ROLE_TITLE=""
SENIORITY=""
LOCATION=""
EMPLOYMENT_TYPE=""
PRIORITY=""
FAMILY=""
FORCE=0

# flow controls
DRYRUN=0
COMMIT=0
PUSH=0
MSG="intake: job (JD + tracking)"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --company) COMPANY="${2:-}"; shift 2 ;;
    --date) DATE="${2:-}"; shift 2 ;;
    --role) ROLE="${2:-}"; shift 2 ;;
    --url) URL="${2:-}"; shift 2 ;;

    --role-title) ROLE_TITLE="${2:-}"; shift 2 ;;
    --seniority) SENIORITY="${2:-}"; shift 2 ;;
    --location) LOCATION="${2:-}"; shift 2 ;;
    --employment-type) EMPLOYMENT_TYPE="${2:-}"; shift 2 ;;
    --priority) PRIORITY="${2:-}"; shift 2 ;;
    --family) FAMILY="${2:-}"; shift 2 ;;
    --force) FORCE=1; shift 1 ;;

    --dry-run) DRYRUN=1; shift 1 ;;
    --commit) COMMIT=1; shift 1 ;;
    --push) PUSH=1; shift 1 ;;
    --message) MSG="${2:-}"; shift 2 ;;
    -h|--help) usage ;;
    *) echo "Unknown arg: $1" >&2; usage ;;
  esac
done

[[ -n "$COMPANY" && -n "$DATE" && -n "$ROLE" && -n "$URL" ]] || usage
(( PUSH == 0 || COMMIT == 1 )) || { echo "ERROR: --push requires --commit" >&2; exit 1; }

INIT_ARGS=(--company "$COMPANY" --date "$DATE" --role "$ROLE" --url "$URL")
[[ -n "$ROLE_TITLE" ]] && INIT_ARGS+=(--role-title "$ROLE_TITLE")
[[ -n "$SENIORITY" ]] && INIT_ARGS+=(--seniority "$SENIORITY")
[[ -n "$LOCATION" ]] && INIT_ARGS+=(--location "$LOCATION")
[[ -n "$EMPLOYMENT_TYPE" ]] && INIT_ARGS+=(--employment-type "$EMPLOYMENT_TYPE")
[[ -n "$PRIORITY" ]] && INIT_ARGS+=(--priority "$PRIORITY")
[[ -n "$FAMILY" ]] && INIT_ARGS+=(--family "$FAMILY")
(( FORCE == 1 )) && INIT_ARGS+=(--force)

# 1) INIT (first line from job-intake-init is APP path)
APP="$(job-intake-init "${INIT_ARGS[@]}" | head -n 1)"

[[ -n "$APP" ]] || { echo "ERROR: job-intake-init did not return an app path" >&2; exit 1; }

echo "APP: $APP"
echo

# 2) JD capture from clipboard
if (( DRYRUN == 1 )); then
  job-intake-from-clipboard --app "$APP"
  echo
  echo "DRY RUN complete. Nothing written/committed."
  exit 0
fi

echo "JD capture: copy the full JD text in your browser (Cmd+C), then press Enter here."
read -r -p "Press Enter to read clipboard: " _

job-intake-from-clipboard --app "$APP" --apply $([[ $FORCE -eq 1 ]] && echo --force)

# 3) Commit/push
if (( COMMIT == 1 )); then
  job-intake-commit --app "$APP" $([[ $PUSH -eq 1 ]] && echo "" || echo --no-push)
  if (( PUSH == 1 )); then
    cd "$HOME/secondbrain"
    git push
  fi
else
  echo
  echo "Next:"
  echo "  job-intake-commit --app \"$APP\""
fi

# Print APP path last line too (easy piping/echo)
echo
echo "$APP"
