#!/Users/olivermarroquin/secondbrain/07_system/venvs/docgen/bin/python
import argparse
import subprocess
from pathlib import Path

def die(msg: str, code=1):
    print(f"ERROR: {msg}")
    raise SystemExit(code)

def _rm(p: Path):
    try:
        if p.exists():
            p.unlink()
    except Exception:
        pass

def main():
    ap = argparse.ArgumentParser()
    ap.add_argument("--app", required=True)
    ap.add_argument("--family", default="qa_automation_engineer")
    ap.add_argument("--diff", action="store_true")
    ap.add_argument("--refresh", action="store_true", help="delete keyword-scout.json + ideal-profile.json before regenerating")
    ap.add_argument("--no-write", action="store_true", help="pass through to resume-map-ideal-edits")
    args = ap.parse_args()

    app = Path(args.app).expanduser()
    if not app.is_dir():
        die(f"app dir missing: {app}")

    # Ensure template selection exists (idempotent)
    subprocess.run([
        "resume-select",
        "--app", str(app),
        "--family", args.family,
    ], check=True)

    # Refresh only deletes the intermediate artifacts; proposals will be regenerated by map step.
    if args.refresh:
        _rm(app / "notes" / "keyword-scout.json")
        _rm(app / "notes" / "ideal-profile.json")

    # Generate keyword scout + ideal profile (cache unless missing/empty; --refresh deletes them above)
    ks = app / "notes" / "keyword-scout.json"
    ip = app / "notes" / "ideal-profile.json"

    if (not ks.exists()) or ks.stat().st_size == 0:
        subprocess.run(["resume-keyword-scout", "--app", str(app)], check=True)
    if (not ip.exists()) or ip.stat().st_size == 0:
        subprocess.run(["resume-ideal-profile", "--app", str(app)], check=True)

    # Generate proposals (this is the artifact you approve)
    cmd = ["resume-map-ideal-edits", "--app", str(app)]
    if args.diff:
        cmd.append("--diff")
    if args.no_write:
        cmd.append("--no-write")
    subprocess.run(cmd, check=True)

if __name__ == "__main__":
    main()
